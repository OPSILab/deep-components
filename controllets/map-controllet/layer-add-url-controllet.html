<dom-module id="layer-add-url-controllet">

    <style>
        :host {
            --paper-dropdown-menu-icon: {
                color: #000000;
            };
            --paper-dropdown-menu-ripple: {
                color: #FFFFFF;
            };
            --paper-item-focused-before: {
                background: none;
            };
            --paper-menu-focused-item-after: {
                background: none;
            };
            --paper-input-container-focus-color: #2196F3;

        }

        iron-list {
            --iron-list-items-container: {
                margin: 16px 16px 8px 16px;
            };
        }

        paper-dropdown-menu paper-item {
            padding: 0px 10px;
            font-size: 14px;
            min-height: 24px;
        }

        paper-dropdown-menu paper-item IMG {
            margin-right: 5px;
        }

        paper-dropdown-menu paper-item:hover {
            background: #eee;
        }

        paper-dropdown-menu paper-menu {
            padding: 0px;
        }

        paper-dropdown-menu paper-item.iron-selected {
            background-color: #2196F3;
            color: #FFFFFF;
        }

        #Layer {
            width: 100%;
        }

        #Style {
            min-width: 50%;
        }
    </style>

    <template>

        <paper-input id="Name" label="{{_translate('name')}}" value={{name}} auto-validate required></paper-input>

        <paper-dropdown-menu id="Format" label="{{_translate('format')}}" required hidden="{{edit}}">
            <paper-menu class="dropdown-content" selected="{{formats.Selected}}">
                <template is="dom-repeat" items={{formats.Accepted}} as="format">
                    <paper-item>{{format}}</paper-item>
                </template>
            </paper-menu>
        </paper-dropdown-menu>
        <paper-input label="{{_translate('format')}}" value={{_getFormatText(formats.Selected)}}
                     readonly="{{edit}}" hidden="{{!edit}}"></paper-input>

        <paper-input id="Url" label="{{_translate('url')}}" value={{url}} auto-validate required
                     readonly="{{edit}}" pattern="^(https?|ftp)://[^\s/$.?#].[^\s]*"
        ></paper-input>

        <div hidden="{{!extraWms}}">
            <paper-dropdown-menu id="Layer" label="{{_translate('layer')}}" required
                                 hidden="{{_extraWmsVisibility(edit,formats.Selected)}}">
                <paper-menu class="dropdown-content" selected="{{layers.Selected}}">
                    <template is="dom-repeat" items={{layers.Accepted}} as="layer">
                        <paper-item>{{layer.Title}}</paper-item>
                    </template>
                </paper-menu>
            </paper-dropdown-menu>
        </div>


    </template>

    <script>
        Polymer({

            is: 'layer-add-url-controllet',

            properties: {
                name: {
                    type: String,
                    value: ''
                },
                formats: {
                    type: Object,
                    value: {
                        Selected: '-1',
                        Accepted: ['GeoJSON', 'KML', 'WMS']
                    }
                },
                url: {
                    type: String,
                    value: ''
                },
                extraWms: {type: Boolean, value: false},
                layers: {
                    type: Object,
                    value: {
                        Selected: '-1',
                        Accepted: []
                    }
                },
                layer: {
                    type: Object,
                    value: undefined,
                    observer: '_onLayerChange'
                },

                edit: {
                    type: Boolean,
                    value: false
                }
            },
            observers: [
                '_onNameChange(name)',
                '_onFormatSelect(formats.Selected)',
                '_onUrlChange(url)',
                '_onLayerSelect(layers.Selected)'
            ],
            attached: function () {
                $('paper-material.dropdown-content,paper-material.dropdown-content').perfectScrollbar();
            },
            isValid: function (callback) {
                var countValid = (this.$.Name.validate() ? 1 : 0) + (this.$.Format.validate() ? 1 : 0) + (this.$.Url.validate() ? 1 : 0);
                var countValidExtraWms = (this.$.Layer.validate() ? 1 : 0);
                if (countValid === 3 && (!this.extraWms || countValidExtraWms == 1)) {
                    if (this.edit) {
                        this.layer.set('title', this.name);
                        callback({valid: true, layer: this.layer, error: ''});
                    } else {
                        this.fire('layers-load-start');
                        document.querySelector('map-preview-controllet').addLayer({
                            title: this.name,
                            format: this.formats.Accepted[this.formats.Selected],
                            url: this._extraGetWmsUrl() || this.url,
                            callback: this._onLayerAddEvent(callback).bind(this)
                        });
                    }
                } else callback({valid: false});
            },
            _translate: function (key) {
                return getTranslatedText([this.localName, key]);
            },
            _onNameChange: function (text) {
            },
            _onFormatSelect: function (selectedIndex) {
                if (selectedIndex >= 0) {
                    this.$.Format.invalid = false;
                    this.extraWms = (selectedIndex == 2) && this.layers.Accepted.length;
                }
            },
            _onUrlChange: function (text) {
                this.extraWms = false;
            },
            _onLayerSelect: function (selectedIndex) {
                if (selectedIndex >= 0) {
                    this.$.Layer.invalid = false;
                }
            },
            _onLayerChange: function (layer) {
                if (layer) {
                    this.name = layer.title;
                    this.formats = {
                        Selected: $.inArray(layer.format, this.formats.Accepted),
                        Accepted: this.formats.Accepted
                    };
                    this.url = layer.urlCapabilities || layer.url;
                } else {
                    this.extraWms = false;
                    this.layers = {Selected: -1, Accepted: []}
                }
            },
            _onLayerAddEvent: function (callback) {
                return function (evt) {
                    this.fire('layers-load-end');
                    if (evt.type === 'LayerAdded') {
                        this.$.Url.invalid = false;
                        callback({valid: true, layer: evt.srcElement, error: ''})
                    } else if (evt.detail.wms) {
                        this.layers = {Selected: '-1', Accepted: evt.detail.wms};
                        this.extraWms = true;
                        callback({valid: false, layer: evt.srcElement, error: ''})
                    } else {
                        this.$.Url.invalid = true;
                        callback({valid: false, layer: evt.srcElement, error: evt.detail.error || ''})
                    }
                }
            },
            _getFormatText: function () {
                return this.formats && this.formats.Selected != -1 ? this.formats.Accepted[this.formats.Selected] : '';
            },
            _extraWmsVisibility: function (edit, format) {
                return edit || format != 2;
            },
            _extraGetWmsUrl: function () {
                if (this.extraWms)
                    return this.layers.Accepted[this.layers.Selected].Url;
                return false
            },
            reset: function () {
                this.name = '';
                this.formats = {Selected: -1, Accepted: this.formats.Accepted};
                this.$.Format.invalid = true;
                this.url = '';
            }

        });

    </script>

</dom-module>